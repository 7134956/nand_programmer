LIB_NAME=libch32v30x.a

SRC_DIR=Core/ Peripheral/src/
OBJ_DIR=obj/

TOOLCHAIN=riscv-none-embed-

CC=$(TOOLCHAIN)gcc.exe
AR=$(TOOLCHAIN)ar.exe

CONFIG_FILE=ch32v30x_conf.h

INCLUDES=-include$(CONFIG_FILE)
INCLUDES+=-I.
INCLUDES+=-ICore/
INCLUDES+=-IPeripheral/inc/
INCLUDES+=-IUser/

CFLAGS=-g -Wall -Werror -O3
CFLAGS+= $(INCLUDES) -MMD -MP
CFLAGS+=-march=rv32imafc -mabi=ilp32f
CFLAGS+=-ffreestanding -nostdlib

vpath %.c $(SRC_DIR)

SRCS_CORE=core_riscv.c

SRCS_PERIPH=ch32v30x_misc.c ch32v30x_dma.c ch32v30x_gpio.c \
  ch32v30x_rcc.c ch32v30x_tim.c ch32v30x_adc.c ch32v30x_crc.c \
  ch32v30x_exti.c ch32v30x_i2c.c ch32v30x_rtc.c ch32v30x_usart.c \
  ch32v30x_bkp.c ch32v30x_dac.c ch32v30x_flash.c ch32v30x_iwdg.c \
  ch32v30x_sdio.c ch32v30x_wwdg.c ch32v30x_can.c ch32v30x_dbgmcu.c \
  ch32v30x_fsmc.c ch32v30x_pwr.c ch32v30x_spi.c

SRCS=$(SRCS_CORE) $(SRCS_PERIPH)

OBJS=$(addprefix $(OBJ_DIR),$(SRCS:.c=.o))
DEPS=$(OBJS:%.o=%.d)

all: dirs $(LIB_NAME)

dirs:
	if not exist $(OBJ_DIR) mkdir $(OBJ_DIR)

$(LIB_NAME): $(OBJS)
	$(AR) -r $@ $^

$(OBJ_DIR)/%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

-include $(DEPS)

clean:
	if exist $(OBJ_DIR) rd /s /q $(OBJ_DIR)

